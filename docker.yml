- name: Deploy to EC2 and Debug
  uses: appleboy/ssh-action@v1.0.0
  with:
    host: 13.202.46.178
    username: ec2-user
    key: ${{ secrets.EC2_SSH_KEY }}
    script: |
      set -ex  # Exit on error, show all commands

      echo "📁 Cloning or entering project directory..."
      if [ -d ~/project-1-maven-jenkins-CICD-docker-eks- ]; then
        cd ~/project-1-maven-jenkins-CICD-docker-eks-
        git pull
      else
        git clone https://github.com/swathichaganti91/project-1-maven-jenkins-CICD-docker-eks-.git
        cd project-1-maven-jenkins-CICD-docker-eks-
      fi

      echo "📄 Checking for Dockerfile..."
      ls -l Dockerfile || (echo "❌ Dockerfile not found!" && exit 1)

      echo "🧹 Stopping old container (if exists)..."
      docker stop docker1 || true
      docker rm docker1 || true

      echo "🐳 Building image..."
      docker build -t docker1 . || (echo "❌ Build failed" && exit 1)

      echo "📦 Docker images:"
      docker images

      echo "🚀 Running container..."
      docker run -p 8075:8080 -d --name docker1 docker1 || (echo "❌ Run failed" && exit 1)

      echo "📦 Containers:"
      docker ps -a

      echo "📜 Logs:"
      docker logs docker1 || true
