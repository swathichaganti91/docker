- name: Deploy to EC2
  uses: appleboy/ssh-action@v1.0.0
  with:
    host: 13.202.46.178
    username: ec2-user
    key: ${{ secrets.EC2_SSH_KEY }}
    script: |
      set -ex   # Exit on error + print commands

      echo "Navigating to project directory or cloning repo..."
      cd ~/project-1-maven-jenkins-CICD-docker-eks- || (git clone https://github.com/swathichaganti91/project-1-maven-jenkins-CICD-docker-eks-.git && cd project-1-maven-jenkins-CICD-docker-eks-)

      echo "Stopping existing container if any..."
      docker stop docker1 || true
      docker rm docker1 || true

      echo "Building Docker image..."
      docker build -t docker1 .

      echo "Docker images on host:"
      docker images

      echo "Running container..."
      docker run -p 8075:8080 -d --name docker1 docker1

      echo "Containers running now:"
      docker ps -a

      echo "Logs from container (if any):"
      docker logs docker1 || true
